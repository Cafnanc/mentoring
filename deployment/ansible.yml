---
- hosts: elevate
  vars:
    #contents: "{{ lookup('file', '/opt/rsync/text.txt') }}"
    project_path: /opt/backend/deployment
    GIT_REPO: https://github.com/ELEVATE-Project/notification.git
  tasks:
    - name: Slurp hosts file
      slurp:
        src: "{{ project_path }}/.token"
      register: slurpfile
    #- debug: msg="{{ slurpfile['content'] | b64decode }}"
    #- debug: msg="the value of foo.txt is {{ contents }}"
    - name: Run vault credentials
      shell: "curl --location --request GET '{{ vaultAddress }}notification' --header 'X-Vault-Token: {{ slurpfile['content'] | b64decode }}' | jq '.data' > '{{ project_path 
}}/data2.json'"
      register: vaultCurl
    - name: Create release folder
      set_fact:
        release_path: "{{ project_path }}/releases/{{ lookup('pipe','date +%Y%m%d%H%M%S') }}"
        current_path: "{{ project_path }}/notification"

    - name: Retrieve current release folder
      command: readlink -f notification
      register: current_release_path
      ignore_errors: yes
      args:
        chdir: "{{ project_path }}"
    - name: Create new folder
      file:
        dest={{ release_path }}
        mode=0755
        recurse=yes
        state=directory
    - name: Clone the repository
      git:
        repo: "{{ GIT_REPO }}"
        dest: "{{ release_path }}"
        clone: yes
        update: yes
        version: "{{ gitBranch }}"

    - name: Retrieve current tag number
      command: "git describe --abbrev=0 --tags"
      args:
        chdir: "{{ GIT_REPO }}"
      register: current_tag
      ignore_errors: true

    - name: Extract numeric part of tag
      set_fact:
        current_tag_numeric: "{{ current_tag.stdout | regex_replace('^(.*?)(\\d+)$', '\\2') | default(0) | int }}"
    
    - name: Increment tag number
      set_fact:
        next_tag_numeric: "{{ current_tag_numeric + 1 }}"

    - name: Determine the next tag number
      set_fact:
        next_tag_number: "Release_{{ gitBranch }}_{{ next_tag_numeric }}"

    - name: Create Git Tag
      shell: "git remote set-url origin https://{{ GIT_USER_NAME }}:{{ GIT_TOKEN }}@github.com/ELEVATE-Project/notification.git
      && git config --global user.email '{{ GIT_EMAIL }}' && 
       git config --global user.name '{{ GIT_USER_NAME }}' && 
       git tag -a '{{ next_tag_number }}' -m 'Tag creation for {{ next_tag_number }}' 
       && git push origin {{ next_tag_number }}"
      args:
        chdir: "{{ release_path }}"


    - name: Update npm
      shell: cd {{release_path}}/src && npm i
    
    - name: Delete Old Folder & create folder
      shell: rm -rf {{ current_path }} &&  cd {{ project_path }} && mkdir notification

    - name: Move code from release  to service folder
      shell: mv "{{ release_path }}"/* {{ current_path }}/
    
    - name: set permission
      shell: chmod 744 {{ current_path }}/src/scripts/json2env.sh  
      
    - name: generate .env 
      shell: cat {{ project_path }}/data2.json | {{ current_path }}/src/scripts/json2env.sh > {{ current_path }}/src/.env
      register: envConfig 
    - debug: msg=" cred {{ envConfig }} "

    - name: Run Migrations
      command: "chdir={{current_path}}/src npx sequelize-cli db:migrate"

    - name: Delete old pm2 process
      command: pm2 delete elevate-notification
      ignore_errors: yes

    - name: Delete release folder
      shell: rm -rf  {{ release_path }}

    - name: Start pm2
      command: "chdir={{current_path}}/src pm2 start app.js -i 2 --name elevate-notification"
      register: pm2Info

    - name: debug info
      debug:
         msg: "Pm2 log {{pm2Info}}"